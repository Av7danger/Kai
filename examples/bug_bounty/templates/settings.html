{% extends "base.html" %}

{% block title %}Settings - Bug Bounty Hunter Pro{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Settings</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Settings</h1>
        <p class="text-muted mb-0">Configure your bug bounty hunting environment</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-secondary" onclick="loadDefaults()">
            <i class="fas fa-undo"></i> Defaults
        </button>
        <button class="btn btn-success" onclick="saveAllSettings()">
            <i class="fas fa-save"></i> Save Settings
        </button>
    </div>
</div>

<form id="settingsForm" method="POST">
    <div class="row g-4">
        <!-- General Settings -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sliders-h"></i> General Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="max_concurrent_scans" class="form-label">Max Concurrent Scans</label>
                        <input type="number" class="form-control" id="max_concurrent_scans" name="max_concurrent_scans" 
                               value="{{ settings.general.max_concurrent_scans if settings.general else 3 }}" min="1" max="10">
                        <div class="form-text">Maximum number of scans running simultaneously</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scan_timeout" class="form-label">Scan Timeout (minutes)</label>
                        <input type="number" class="form-control" id="scan_timeout" name="scan_timeout"
                               value="{{ settings.general.scan_timeout if settings.general else 60 }}" min="5" max="300">
                        <div class="form-text">Maximum time for scan completion</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="rate_limit" class="form-label">Rate Limit (requests/second)</label>
                        <input type="number" class="form-control" id="rate_limit" name="rate_limit"
                               value="{{ settings.general.rate_limit if settings.general else 10 }}" min="1" max="100">
                        <div class="form-text">Request rate for web scanning</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto_save_results" name="auto_save_results"
                                   {% if not settings.general or settings.general.auto_save_results %}checked{% endif %}>
                            <label class="form-check-label" for="auto_save_results">
                                Auto-save scan results
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_notifications" name="email_notifications"
                                   {% if not settings.general or settings.general.email_notifications %}checked{% endif %}>
                            <label class="form-check-label" for="email_notifications">
                                Enable email notifications
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tool Configuration -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tools"></i> Tool Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="nmap_path" class="form-label">Nmap Path</label>
                        <input type="text" class="form-control" id="nmap_path" name="nmap_path"
                               value="{{ settings.tools.nmap_path if settings.tools else '/usr/bin/nmap' }}">
                        <div class="form-text">Path to nmap executable</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="wordlist_path" class="form-label">Wordlists Directory</label>
                        <input type="text" class="form-control" id="wordlist_path" name="wordlist_path"
                               value="{{ settings.tools.wordlist_path if settings.tools else '/usr/share/wordlists' }}">
                        <div class="form-text">Directory containing wordlists</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="output_directory" class="form-label">Output Directory</label>
                        <input type="text" class="form-control" id="output_directory" name="output_directory"
                               value="{{ settings.tools.output_directory if settings.tools else '~/bb_pro_workspace/results' }}">
                        <div class="form-text">Where to save results</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="user_agent" class="form-label">User Agent</label>
                        <input type="text" class="form-control" id="user_agent" name="user_agent"
                               value="{{ settings.tools.user_agent if settings.tools else 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36' }}">
                        <div class="form-text">User agent for web requests</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Configuration -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-key"></i> API Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="shodan_api_key" class="form-label">Shodan API Key</label>
                        <input type="password" class="form-control" id="shodan_api_key" name="shodan_api_key"
                               value="{{ settings.api.shodan_api_key if settings.api else '' }}" 
                               placeholder="Enter your Shodan API key">
                        <div class="form-text">For IP and service intelligence</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="virustotal_api_key" class="form-label">VirusTotal API Key</label>
                        <input type="password" class="form-control" id="virustotal_api_key" name="virustotal_api_key"
                               value="{{ settings.api.virustotal_api_key if settings.api else '' }}"
                               placeholder="Enter your VirusTotal API key">
                        <div class="form-text">For domain reputation checks</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="gemini_api_key" class="form-label">Google Gemini API Key</label>
                        <input type="password" class="form-control" id="gemini_api_key" name="gemini_api_key"
                               value="{{ settings.api.gemini_api_key if settings.api else '' }}"
                               placeholder="Enter your Gemini API key">
                        <div class="form-text">For AI-powered analysis</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="censys_api_key" class="form-label">Censys API Key</label>
                        <input type="password" class="form-control" id="censys_api_key" name="censys_api_key"
                               value="{{ settings.api.censys_api_key if settings.api else '' }}"
                               placeholder="Enter your Censys API key">
                        <div class="form-text">For certificate discovery</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bell"></i> Notifications</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="email_address" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email_address" name="email_address"
                               value="{{ settings.notifications.email_address if settings.notifications else '' }}"
                               placeholder="your@email.com">
                        <div class="form-text">For scan notifications</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="smtp_server" class="form-label">SMTP Server</label>
                        <input type="text" class="form-control" id="smtp_server" name="smtp_server"
                               value="{{ settings.notifications.smtp_server if settings.notifications else '' }}"
                               placeholder="smtp.gmail.com">
                        <div class="form-text">Email server configuration</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="smtp_port" class="form-label">SMTP Port</label>
                        <input type="number" class="form-control" id="smtp_port" name="smtp_port"
                               value="{{ settings.notifications.smtp_port if settings.notifications else 587 }}">
                        <div class="form-text">Usually 587 or 465</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="discord_webhook" class="form-label">Discord Webhook (Optional)</label>
                        <input type="url" class="form-control" id="discord_webhook" name="discord_webhook"
                               value="{{ settings.notifications.discord_webhook if settings.notifications else '' }}"
                               placeholder="https://discord.com/api/webhooks/...">
                        <div class="form-text">For Discord notifications</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cogs"></i> Configuration Management</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap mb-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save All Settings
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="loadDefaults()">
                            <i class="fas fa-undo"></i> Load Defaults
                        </button>
                        <button type="button" class="btn btn-info" onclick="exportSettings()">
                            <i class="fas fa-download"></i> Export Config
                        </button>
                        <button type="button" class="btn btn-warning" onclick="importSettings()">
                            <i class="fas fa-upload"></i> Import Config
                        </button>
                        <button type="button" class="btn btn-success" onclick="testConfiguration()">
                            <i class="fas fa-check"></i> Test Configuration
                        </button>
                    </div>
                    
                    <div id="testResults" class="mt-3" style="display: none;">
                        <h6>Configuration Test Results:</h6>
                        <div id="testOutput"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<input type="file" id="importFile" style="display: none;" accept=".json">

{% endblock %}

{% block extra_js %}
<script>
function saveAllSettings() {
    const form = document.getElementById('settingsForm');
    const formData = new FormData(form);
    
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="loading-spinner me-2"></span>Saving...';
    saveBtn.disabled = true;
    
    fetch('/settings', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showNotification('Settings saved successfully!', 'success');
        } else {
            showNotification('Failed to save settings', 'danger');
        }
    })
    .catch(error => {
        showNotification('Error saving settings', 'danger');
        console.error(error);
    })
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function loadDefaults() {
    if (confirm('This will reset all settings to default values. Continue?')) {
        // Reset form fields
        document.getElementById('max_concurrent_scans').value = '3';
        document.getElementById('scan_timeout').value = '60';
        document.getElementById('rate_limit').value = '10';
        document.getElementById('auto_save_results').checked = true;
        document.getElementById('email_notifications').checked = true;
        
        document.getElementById('nmap_path').value = '/usr/bin/nmap';
        document.getElementById('wordlist_path').value = '/usr/share/wordlists';
        document.getElementById('output_directory').value = '~/bb_pro_workspace/results';
        document.getElementById('user_agent').value = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36';
        
        // Clear API keys
        document.getElementById('shodan_api_key').value = '';
        document.getElementById('virustotal_api_key').value = '';
        document.getElementById('gemini_api_key').value = '';
        document.getElementById('censys_api_key').value = '';
        
        // Clear notifications
        document.getElementById('email_address').value = '';
        document.getElementById('smtp_server').value = '';
        document.getElementById('smtp_port').value = '587';
        document.getElementById('discord_webhook').value = '';
        
        showNotification('Settings reset to defaults', 'info');
    }
}

function exportSettings() {
    fetch('/api/settings')
    .then(response => response.json())
    .then(settings => {
        const dataStr = JSON.stringify(settings, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'bb_pro_settings.json';
        link.click();
        
        showNotification('Settings exported successfully!', 'success');
    })
    .catch(error => {
        showNotification('Failed to export settings', 'danger');
    });
}

function importSettings() {
    document.getElementById('importFile').click();
}

function testConfiguration() {
    const testBtn = event.target;
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<span class="loading-spinner me-2"></span>Testing...';
    testBtn.disabled = true;
    
    fetch('/api/test_configuration', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const results = data.results;
            let output = '';
            
            for (const [key, result] of Object.entries(results)) {
                const icon = result.status === 'success' ? 'fa-check text-success' : 
                            result.status === 'error' ? 'fa-times text-danger' : 
                            'fa-exclamation-triangle text-warning';
                            
                output += `
                    <div class="alert alert-${result.status === 'success' ? 'success' : result.status === 'error' ? 'danger' : 'warning'} py-2">
                        <i class="fas ${icon} me-2"></i>
                        <strong>${key.toUpperCase()}:</strong> ${result.message}
                    </div>
                `;
            }
            
            document.getElementById('testOutput').innerHTML = output;
            document.getElementById('testResults').style.display = 'block';
            
            showNotification('Configuration test completed!', 'info');
        } else {
            showNotification('Configuration test failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showNotification('Error testing configuration', 'danger');
        console.error(error);
    })
    .finally(() => {
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    });
}

// Handle file import
document.getElementById('importFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const settings = JSON.parse(e.target.result);
                
                // Apply imported settings to form
                if (settings.general) {
                    document.getElementById('max_concurrent_scans').value = settings.general.max_concurrent_scans || 3;
                    document.getElementById('scan_timeout').value = settings.general.scan_timeout || 60;
                    document.getElementById('rate_limit').value = settings.general.rate_limit || 10;
                    document.getElementById('auto_save_results').checked = settings.general.auto_save_results !== false;
                    document.getElementById('email_notifications').checked = settings.general.email_notifications !== false;
                }
                
                if (settings.tools) {
                    document.getElementById('nmap_path').value = settings.tools.nmap_path || '/usr/bin/nmap';
                    document.getElementById('wordlist_path').value = settings.tools.wordlist_path || '/usr/share/wordlists';
                    document.getElementById('output_directory').value = settings.tools.output_directory || '~/bb_pro_workspace/results';
                    document.getElementById('user_agent').value = settings.tools.user_agent || 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36';
                }
                
                if (settings.api) {
                    document.getElementById('shodan_api_key').value = settings.api.shodan_api_key || '';
                    document.getElementById('virustotal_api_key').value = settings.api.virustotal_api_key || '';
                    document.getElementById('gemini_api_key').value = settings.api.gemini_api_key || '';
                    document.getElementById('censys_api_key').value = settings.api.censys_api_key || '';
                }
                
                if (settings.notifications) {
                    document.getElementById('email_address').value = settings.notifications.email_address || '';
                    document.getElementById('smtp_server').value = settings.notifications.smtp_server || '';
                    document.getElementById('smtp_port').value = settings.notifications.smtp_port || 587;
                    document.getElementById('discord_webhook').value = settings.notifications.discord_webhook || '';
                }
                
                showNotification('Settings imported successfully!', 'success');
            } catch (error) {
                showNotification('Error importing settings: Invalid JSON file', 'danger');
            }
        };
        reader.readAsText(file);
    }
});

// Form submission handler
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveAllSettings();
});
</script>
{% endblock %}

<div class="row">
    <!-- General Settings -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-sliders-h"></i> General Settings</h5>
            </div>
            <div class="card-body">
                <form id="generalSettings">
                    <div class="mb-3">
                        <label for="max_concurrent_scans" class="form-label">Max Concurrent Scans</label>
                        <input type="number" class="form-control" id="max_concurrent_scans" value="3" min="1" max="10">
                        <div class="form-text">Maximum number of scans that can run simultaneously</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scan_timeout" class="form-label">Scan Timeout (minutes)</label>
                        <input type="number" class="form-control" id="scan_timeout" value="60" min="5" max="300">
                        <div class="form-text">How long to wait before timing out a scan</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="rate_limit" class="form-label">Rate Limit (requests/second)</label>
                        <input type="number" class="form-control" id="rate_limit" value="10" min="1" max="100">
                        <div class="form-text">Maximum requests per second for web scanning</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto_save_results" checked>
                            <label class="form-check-label" for="auto_save_results">
                                Auto-save scan results
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_notifications" checked>
                            <label class="form-check-label" for="email_notifications">
                                Enable email notifications
                            </label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tool Configuration -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tools"></i> Tool Configuration</h5>
            </div>
            <div class="card-body">
                <form id="toolSettings">
                    <div class="mb-3">
                        <label for="nmap_path" class="form-label">Nmap Path</label>
                        <input type="text" class="form-control" id="nmap_path" value="/usr/bin/nmap">
                        <div class="form-text">Path to nmap executable</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="wordlist_path" class="form-label">Default Wordlist Directory</label>
                        <input type="text" class="form-control" id="wordlist_path" value="/usr/share/wordlists">
                        <div class="form-text">Directory containing wordlists</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="output_directory" class="form-label">Output Directory</label>
                        <input type="text" class="form-control" id="output_directory" value="~/bb_pro_workspace/results">
                        <div class="form-text">Where to save scan results and reports</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="user_agent" class="form-label">User Agent</label>
                        <input type="text" class="form-control" id="user_agent" 
                               value="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36">
                        <div class="form-text">User agent string for web requests</div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- API Configuration -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-key"></i> API Configuration</h5>
            </div>
            <div class="card-body">
                <form id="apiSettings">
                    <div class="mb-3">
                        <label for="shodan_api_key" class="form-label">Shodan API Key</label>
                        <input type="password" class="form-control" id="shodan_api_key" placeholder="Enter your Shodan API key">
                        <div class="form-text">Used for IP and service intelligence gathering</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="virustotal_api_key" class="form-label">VirusTotal API Key</label>
                        <input type="password" class="form-control" id="virustotal_api_key" placeholder="Enter your VirusTotal API key">
                        <div class="form-text">Used for domain and URL reputation checks</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="gemini_api_key" class="form-label">Google Gemini API Key</label>
                        <input type="password" class="form-control" id="gemini_api_key" placeholder="Enter your Gemini API key">
                        <div class="form-text">Used for AI-powered vulnerability analysis</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="censys_api_key" class="form-label">Censys API Key</label>
                        <input type="password" class="form-control" id="censys_api_key" placeholder="Enter your Censys API key">
                        <div class="form-text">Used for certificate and host discovery</div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Settings -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bell"></i> Notification Settings</h5>
            </div>
            <div class="card-body">
                <form id="notificationSettings">
                    <div class="mb-3">
                        <label for="email_address" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email_address" placeholder="your@email.com">
                        <div class="form-text">Where to send scan completion notifications</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="smtp_server" class="form-label">SMTP Server</label>
                        <input type="text" class="form-control" id="smtp_server" placeholder="smtp.gmail.com">
                        <div class="form-text">SMTP server for sending emails</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="smtp_port" class="form-label">SMTP Port</label>
                        <input type="number" class="form-control" id="smtp_port" value="587">
                        <div class="form-text">SMTP server port (usually 587 or 465)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="discord_webhook" class="form-label">Discord Webhook URL</label>
                        <input type="url" class="form-control" id="discord_webhook" placeholder="https://discord.com/api/webhooks/...">
                        <div class="form-text">Optional: Discord webhook for notifications</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="slack_webhook" class="form-label">Slack Webhook URL</label>
                        <input type="url" class="form-control" id="slack_webhook" placeholder="https://hooks.slack.com/services/...">
                        <div class="form-text">Optional: Slack webhook for notifications</div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Advanced Settings -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Advanced Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Scan Configuration</h6>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_subdomain_enum" checked>
                                <label class="form-check-label" for="enable_subdomain_enum">
                                    Enable subdomain enumeration
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_port_scan" checked>
                                <label class="form-check-label" for="enable_port_scan">
                                    Enable port scanning
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_web_crawling" checked>
                                <label class="form-check-label" for="enable_web_crawling">
                                    Enable web crawling
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <h6>Security</h6>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="encrypt_data" checked>
                                <label class="form-check-label" for="encrypt_data">
                                    Encrypt stored data
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="log_activities" checked>
                                <label class="form-check-label" for="log_activities">
                                    Log all activities
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="require_auth">
                                <label class="form-check-label" for="require_auth">
                                    Require authentication
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <h6>Performance</h6>
                        <div class="mb-3">
                            <label for="thread_count" class="form-label">Thread Count</label>
                            <input type="number" class="form-control" id="thread_count" value="20" min="1" max="100">
                        </div>
                        <div class="mb-3">
                            <label for="memory_limit" class="form-label">Memory Limit (MB)</label>
                            <input type="number" class="form-control" id="memory_limit" value="512" min="128" max="4096">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_caching" checked>
                                <label class="form-check-label" for="enable_caching">
                                    Enable result caching
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> Configuration Management</h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save All Settings
                    </button>
                    <button class="btn btn-secondary" onclick="loadDefaultSettings()">
                        <i class="fas fa-undo"></i> Load Defaults
                    </button>
                    <button class="btn btn-info" onclick="exportSettings()">
                        <i class="fas fa-download"></i> Export Configuration
                    </button>
                    <button class="btn btn-warning" onclick="importSettings()">
                        <i class="fas fa-upload"></i> Import Configuration
                    </button>
                    <button class="btn btn-success" onclick="testConfiguration()">
                        <i class="fas fa-check"></i> Test Configuration
                    </button>
                </div>
                <input type="file" id="importFile" style="display: none;" accept=".json">
            </div>
        </div>
    </div>
</div>

<script>
function saveSettings() {
    // Collect all settings
    const settings = {
        general: {
            max_concurrent_scans: document.getElementById('max_concurrent_scans').value,
            scan_timeout: document.getElementById('scan_timeout').value,
            rate_limit: document.getElementById('rate_limit').value,
            auto_save_results: document.getElementById('auto_save_results').checked,
            email_notifications: document.getElementById('email_notifications').checked
        },
        tools: {
            nmap_path: document.getElementById('nmap_path').value,
            wordlist_path: document.getElementById('wordlist_path').value,
            output_directory: document.getElementById('output_directory').value,
            user_agent: document.getElementById('user_agent').value
        },
        api: {
            shodan_api_key: document.getElementById('shodan_api_key').value,
            virustotal_api_key: document.getElementById('virustotal_api_key').value,
            gemini_api_key: document.getElementById('gemini_api_key').value,
            censys_api_key: document.getElementById('censys_api_key').value
        },
        notifications: {
            email_address: document.getElementById('email_address').value,
            smtp_server: document.getElementById('smtp_server').value,
            smtp_port: document.getElementById('smtp_port').value,
            discord_webhook: document.getElementById('discord_webhook').value,
            slack_webhook: document.getElementById('slack_webhook').value
        },
        advanced: {
            enable_subdomain_enum: document.getElementById('enable_subdomain_enum').checked,
            enable_port_scan: document.getElementById('enable_port_scan').checked,
            enable_web_crawling: document.getElementById('enable_web_crawling').checked,
            encrypt_data: document.getElementById('encrypt_data').checked,
            log_activities: document.getElementById('log_activities').checked,
            require_auth: document.getElementById('require_auth').checked,
            thread_count: document.getElementById('thread_count').value,
            memory_limit: document.getElementById('memory_limit').value,
            enable_caching: document.getElementById('enable_caching').checked
        }
    };

    // Save to localStorage
    localStorage.setItem('bb_pro_settings', JSON.stringify(settings));
    
    showAlert('Settings saved successfully!', 'success');
}

function loadDefaultSettings() {
    if (confirm('This will reset all settings to default values. Continue?')) {
        // Reset all form fields to default values
        document.getElementById('max_concurrent_scans').value = '3';
        document.getElementById('scan_timeout').value = '60';
        document.getElementById('rate_limit').value = '10';
        document.getElementById('auto_save_results').checked = true;
        document.getElementById('email_notifications').checked = true;
        
        document.getElementById('nmap_path').value = '/usr/bin/nmap';
        document.getElementById('wordlist_path').value = '/usr/share/wordlists';
        document.getElementById('output_directory').value = '~/bb_pro_workspace/results';
        document.getElementById('user_agent').value = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36';
        
        // Clear API keys
        document.getElementById('shodan_api_key').value = '';
        document.getElementById('virustotal_api_key').value = '';
        document.getElementById('gemini_api_key').value = '';
        document.getElementById('censys_api_key').value = '';
        
        // Clear notification settings
        document.getElementById('email_address').value = '';
        document.getElementById('smtp_server').value = '';
        document.getElementById('smtp_port').value = '587';
        document.getElementById('discord_webhook').value = '';
        document.getElementById('slack_webhook').value = '';
        
        // Reset advanced settings
        document.getElementById('enable_subdomain_enum').checked = true;
        document.getElementById('enable_port_scan').checked = true;
        document.getElementById('enable_web_crawling').checked = true;
        document.getElementById('encrypt_data').checked = true;
        document.getElementById('log_activities').checked = true;
        document.getElementById('require_auth').checked = false;
        document.getElementById('thread_count').value = '20';
        document.getElementById('memory_limit').value = '512';
        document.getElementById('enable_caching').checked = true;
        
        showAlert('Settings reset to defaults!', 'info');
    }
}

function exportSettings() {
    const settings = JSON.parse(localStorage.getItem('bb_pro_settings') || '{}');
    const dataStr = JSON.stringify(settings, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'bb_pro_settings.json';
    link.click();
    
    showAlert('Settings exported successfully!', 'success');
}

function importSettings() {
    document.getElementById('importFile').click();
}

function testConfiguration() {
    showAlert('Testing configuration... This may take a moment.', 'info');
    
    // Simulate configuration test
    setTimeout(() => {
        showAlert('Configuration test completed! All settings appear valid.', 'success');
    }, 2000);
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedSettings = localStorage.getItem('bb_pro_settings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        
        // Load general settings
        if (settings.general) {
            document.getElementById('max_concurrent_scans').value = settings.general.max_concurrent_scans || '3';
            document.getElementById('scan_timeout').value = settings.general.scan_timeout || '60';
            document.getElementById('rate_limit').value = settings.general.rate_limit || '10';
            document.getElementById('auto_save_results').checked = settings.general.auto_save_results !== false;
            document.getElementById('email_notifications').checked = settings.general.email_notifications !== false;
        }
        
        // Load other settings...
        // (Implementation continues for all setting categories)
    }
});

// Handle file import
document.getElementById('importFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const settings = JSON.parse(e.target.result);
                localStorage.setItem('bb_pro_settings', JSON.stringify(settings));
                location.reload(); // Reload page to apply imported settings
            } catch (error) {
                showAlert('Error importing settings: Invalid JSON file', 'danger');
            }
        };
        reader.readAsText(file);
    }
});
</script>
{% endblock %}
