<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Next-Gen Vulnerability Analysis{% endblock %}</title>
    
    <!-- Meta tags for PWA -->
    <meta name="description" content="Advanced AI-powered vulnerability analysis platform">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style">
    
    <!-- CSS Frameworks -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    
    <!-- Chart libraries -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Advanced CSS Variables and Styling -->
    <style>
        :root {
            /* Color Palette */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            
            /* Dark Theme */
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: #1e1e3f;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-color: #2d3748;
            --shadow-color: rgba(0, 0, 0, 0.3);
            
            /* Light Theme */
            --bg-primary-light: #ffffff;
            --bg-secondary-light: #f8fafc;
            --bg-tertiary-light: #f1f5f9;
            --bg-card-light: #ffffff;
            --text-primary-light: #1e293b;
            --text-secondary-light: #475569;
            --text-muted-light: #64748b;
            --border-color-light: #e2e8f0;
            --shadow-color-light: rgba(0, 0, 0, 0.1);
            
            /* Layout */
            --sidebar-width: 320px;
            --header-height: 70px;
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Animation */
            --pulse-animation: pulse 2s infinite;
            --fade-in: fadeIn 0.6s ease;
            --slide-in: slideInUp 0.4s ease;
        }
        
        /* Light theme overrides */
        [data-theme="light"] {
            --bg-primary: var(--bg-primary-light);
            --bg-secondary: var(--bg-secondary-light);
            --bg-tertiary: var(--bg-tertiary-light);
            --bg-card: var(--bg-card-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --text-muted: var(--text-muted-light);
            --border-color: var(--border-color-light);
            --shadow-color: var(--shadow-color-light);
        }
        
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Layout Components */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
        }
        
        .sidebar.collapsed {
            width: 80px;
        }
        
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
            background: var(--bg-primary);
        }
        
        .sidebar.collapsed + .main-content {
            margin-left: 80px;
        }
        
        .top-header {
            height: var(--header-height);
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 999;
            display: flex;
            align-items: center;
            padding: 0 2rem;
            box-shadow: var(--shadow);
        }
        
        .content-area {
            padding: 2rem;
            min-height: calc(100vh - var(--header-height));
        }
        
        /* Sidebar Components */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        
        .sidebar-logo {
            font-size: var(--font-size-xl);
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .sidebar-nav {
            padding: 1rem 0;
        }
        
        .nav-section {
            margin-bottom: 2rem;
        }
        
        .nav-section-title {
            padding: 0 1.5rem 0.5rem;
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.1em;
        }
        
        .nav-item {
            display: block;
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .nav-item:hover {
            color: var(--text-primary);
            background: rgba(99, 102, 241, 0.1);
            text-decoration: none;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .nav-item .icon {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }
        
        .nav-badge {
            background: var(--danger);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: var(--font-size-xs);
            margin-left: auto;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
            font-weight: 600;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Stat Cards */
        .stat-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: var(--font-size-2xl);
            opacity: 0.3;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: var(--transition-fast);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: var(--font-size-sm);
        }
        
        .btn-lg {
            padding: 1rem 2rem;
            font-size: var(--font-size-lg);
        }
        
        /* Forms */
        .form-control {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            transition: var(--transition-fast);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-label {
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        /* Tables */
        .table {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .table thead {
            background: var(--bg-secondary);
        }
        
        .table th {
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: var(--font-size-xs);
            letter-spacing: 0.1em;
            padding: 1rem;
        }
        
        .table td {
            border: none;
            color: var(--text-primary);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        /* Badges */
        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .badge-critical {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
        }
        
        .badge-high {
            background: linear-gradient(135deg, #ea580c, #f59e0b);
            color: white;
        }
        
        .badge-medium {
            background: linear-gradient(135deg, #d97706, #f59e0b);
            color: white;
        }
        
        .badge-low {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
        }
        
        .badge-info {
            background: linear-gradient(135deg, #0284c7, #06b6d4);
            color: white;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Utilities */
        .text-gradient {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.6s ease;
        }
        
        .animate-slide-up {
            animation: slideInUp 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Theme Toggle */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            transition: var(--transition);
        }
        
        [data-theme="light"] .theme-toggle::before {
            transform: translateX(28px);
        }
        
        /* Real-time indicators */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success);
            font-size: var(--font-size-sm);
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .top-header {
                padding: 0 1rem;
            }
        }
        
        /* Print Styles */
        @media print {
            .sidebar,
            .top-header {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #1a1a1a;
                --text-primary: #ffffff;
                --border-color: #ffffff;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        /* Focus Styles for Accessibility */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Custom Components */
        .vulnerability-card {
            position: relative;
            overflow: hidden;
        }
        
        .vulnerability-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }
        
        .vulnerability-card.critical::before {
            background: var(--danger);
        }
        
        .vulnerability-card.high::before {
            background: #ea580c;
        }
        
        .vulnerability-card.medium::before {
            background: var(--warning);
        }
        
        .vulnerability-card.low::before {
            background: var(--success);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dasharray 0.35s;
            transform-origin: 50% 50%;
        }
        
        .ai-typing {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ai-typing::after {
            content: '';
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: scale(1); opacity: 1; }
            30% { transform: scale(1.5); opacity: 0.5; }
        }
    </style>
    
    <!-- Additional CSS from child templates -->
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: var(--bg-primary); z-index: 9999;">
        <div class="text-center">
            <div class="loading mb-3" style="width: 40px; height: 40px; border-width: 4px;"></div>
            <div class="h5 text-gradient">Loading Next-Gen Platform...</div>
        </div>
    </div>
    
    <div class="app-layout">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-shield-virus"></i>
                    <span class="sidebar-text">VulnAnalyzer</span>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Analytics</div>
                    <a href="{{ url_for('index') }}" class="nav-item {% if request.endpoint == 'index' %}active{% endif %}">
                        <i class="fas fa-chart-line icon"></i>
                        <span class="sidebar-text">Dashboard</span>
                        <span class="live-indicator ms-auto">
                            <span class="live-dot"></span>
                            <span class="sidebar-text">LIVE</span>
                        </span>
                    </a>
                    <a href="{{ url_for('vulnerabilities') }}" class="nav-item {% if request.endpoint == 'vulnerabilities' %}active{% endif %}">
                        <i class="fas fa-bug icon"></i>
                        <span class="sidebar-text">Vulnerabilities</span>
                        <span class="nav-badge">{{ stats.get('by_status', {}).get('new', 0) }}</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Analysis</div>
                    <a href="#" class="nav-item" onclick="startQuickScan()">
                        <i class="fas fa-search icon"></i>
                        <span class="sidebar-text">Quick Scan</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showAIAnalysis()">
                        <i class="fas fa-robot icon"></i>
                        <span class="sidebar-text">AI Analysis</span>
                        <span class="nav-badge">AI</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-flask icon"></i>
                        <span class="sidebar-text">PoC Generator</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Reporting</div>
                    <a href="#" class="nav-item">
                        <i class="fas fa-file-alt icon"></i>
                        <span class="sidebar-text">Reports</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-download icon"></i>
                        <span class="sidebar-text">Export</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <a href="#" class="nav-item">
                        <i class="fas fa-cog icon"></i>
                        <span class="sidebar-text">Settings</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-chart-bar icon"></i>
                        <span class="sidebar-text">Metrics</span>
                    </a>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <button class="btn btn-outline btn-sm me-3" onclick="toggleSidebar()" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="d-flex align-items-center flex-grow-1">
                    <div class="me-auto">
                        <h1 class="h4 mb-0 text-gradient">{% block page_title %}Next-Gen Vulnerability Analysis{% endblock %}</h1>
                        <small class="text-muted">{% block page_subtitle %}AI-Powered Security Platform{% endblock %}</small>
                    </div>
                    
                    <!-- Real-time Status -->
                    <div class="d-flex align-items-center gap-3">
                        <div class="live-indicator">
                            <span class="live-dot"></span>
                            <span>Connected</span>
                        </div>
                        
                        <!-- Theme Toggle -->
                        <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme"></div>
                        
                        <!-- System Stats -->
                        <div class="d-flex align-items-center gap-2 text-muted">
                            <i class="fas fa-microchip"></i>
                            <span id="cpu-usage">0%</span>
                        </div>
                        
                        <!-- AI Status -->
                        <div class="dropdown">
                            <button class="btn btn-outline btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-robot"></i>
                                AI Status
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                {% for provider, config in ai_providers.items() %}
                                <li>
                                    <div class="dropdown-item d-flex justify-content-between">
                                        <span>{{ provider.title() }}</span>
                                        <span class="badge {% if config.available %}badge-success{% else %}badge-secondary{% endif %}">
                                            {% if config.available %}Online{% else %}Offline{% endif %}
                                        </span>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="mb-4">
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show animate-slide-up" role="alert">
                                    <i class="fas fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                
                <!-- Main Content -->
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    {% block modals %}{% endblock %}
    
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    
    <!-- Core JavaScript -->
    <script>
        // Global Configuration
        const CONFIG = {
            wsNamespace: '/realtime',
            apiBase: '/api',
            theme: localStorage.getItem('theme') || 'dark',
            sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true'
        };
        
        // Initialize Socket.IO
        const socket = io(CONFIG.wsNamespace);
        
        // Core Application Class
        class VulnAnalyzerApp {
            constructor() {
                this.init();
                this.setupEventListeners();
                this.connectWebSocket();
                this.startRealtimeUpdates();
            }
            
            init() {
                // Apply saved theme
                document.documentElement.setAttribute('data-theme', CONFIG.theme);
                
                // Apply sidebar state
                if (CONFIG.sidebarCollapsed) {
                    document.getElementById('sidebar').classList.add('collapsed');
                }
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.body.classList.add('animate-fade-in');
                }, 1000);
            }
            
            setupEventListeners() {
                // Sidebar toggle
                window.toggleSidebar = () => {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.toggle('collapsed');
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebarCollapsed', isCollapsed);
                };
                
                // Theme toggle
                window.toggleTheme = () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                    CONFIG.theme = newTheme;
                };
                
                // Quick scan function
                window.startQuickScan = () => {
                    const url = prompt('Enter URL to scan:');
                    if (url) {
                        this.startAnalysis(url);
                    }
                };
                
                // AI Analysis modal
                window.showAIAnalysis = () => {
                    this.showModal('AI Analysis', this.createAIAnalysisForm());
                };
                
                // Global error handler
                window.addEventListener('error', (e) => {
                    console.error('Global error:', e);
                    this.showNotification('An error occurred', 'error');
                });
            }
            
            connectWebSocket() {
                socket.on('connect', () => {
                    console.log('WebSocket connected');
                    this.updateConnectionStatus(true);
                });
                
                socket.on('disconnect', () => {
                    console.log('WebSocket disconnected');
                    this.updateConnectionStatus(false);
                });
                
                socket.on('metrics_update', (data) => {
                    this.updateRealtimeMetrics(data);
                });
                
                socket.on('vulnerability_found', (data) => {
                    this.handleVulnerabilityFound(data);
                });
                
                socket.on('analysis_started', (data) => {
                    this.showNotification(`Analysis started for ${data.target_url}`, 'info');
                });
                
                socket.on('analysis_completed', (data) => {
                    this.handleAnalysisCompleted(data);
                });
                
                socket.on('analysis_error', (data) => {
                    this.showNotification(`Analysis error: ${data.error}`, 'error');
                });
            }
            
            startRealtimeUpdates() {
                // Update system stats every 5 seconds
                setInterval(() => {
                    this.updateSystemStats();
                }, 5000);
                
                // Animate counters
                this.animateCounters();
            }
            
            updateConnectionStatus(connected) {
                const indicators = document.querySelectorAll('.live-indicator');
                indicators.forEach(indicator => {
                    const dot = indicator.querySelector('.live-dot');
                    if (connected) {
                        dot.style.background = 'var(--success)';
                        indicator.querySelector('span:last-child').textContent = 'Connected';
                    } else {
                        dot.style.background = 'var(--danger)';
                        indicator.querySelector('span:last-child').textContent = 'Disconnected';
                    }
                });
            }
            
            updateRealtimeMetrics(data) {
                // Update CPU usage
                const cpuElement = document.getElementById('cpu-usage');
                if (cpuElement) {
                    cpuElement.textContent = `${data.system_load?.toFixed(1) || 0}%`;
                }
                
                // Update other metrics as needed
                console.log('Metrics updated:', data);
            }
            
            handleVulnerabilityFound(data) {
                this.showNotification(
                    `New ${data.severity} vulnerability found: ${data.title}`,
                    'warning',
                    5000
                );
                
                // Update counters if on dashboard
                this.updateVulnerabilityCounters();
            }
            
            handleAnalysisCompleted(data) {
                this.showNotification(
                    `Analysis completed for ${data.target_url}. Found ${data.vulnerabilities_found} vulnerabilities.`,
                    'success',
                    7000
                );
                
                // Refresh current page if viewing vulnerabilities
                if (window.location.pathname.includes('vulnerabilities')) {
                    setTimeout(() => window.location.reload(), 2000);
                }
            }
            
            async startAnalysis(targetUrl, options = {}) {
                try {
                    this.showNotification('Starting analysis...', 'info');
                    
                    const response = await axios.post('/api/analyze', {
                        target_url: targetUrl,
                        ai_provider: options.aiProvider || 'auto',
                        ...options
                    });
                    
                    if (response.data.status === 'started') {
                        this.showNotification('Analysis started successfully', 'success');
                    }
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showNotification('Failed to start analysis', 'error');
                }
            }
            
            async exportVulnerabilities(vulnerabilityIds, format) {
                try {
                    const response = await axios.post('/api/export', {
                        vulnerability_ids: vulnerabilityIds,
                        format: format
                    });
                    
                    if (response.data.status === 'success') {
                        this.showNotification('Export completed', 'success');
                        window.open(response.data.download_url, '_blank');
                    }
                    
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('Export failed', 'error');
                }
            }
            
            showNotification(message, type = 'info', duration = 4000) {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type} position-fixed animate-slide-up`;
                notification.style.cssText = `
                    top: 100px; right: 20px; z-index: 10000; 
                    min-width: 300px; box-shadow: var(--shadow-lg);
                `;
                
                const icon = {
                    'success': 'check-circle',
                    'error': 'exclamation-circle',
                    'warning': 'exclamation-triangle',
                    'info': 'info-circle'
                }[type] || 'info-circle';
                
                notification.innerHTML = `
                    <i class="fas fa-${icon} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            }
            
            showModal(title, content) {
                const modalId = 'dynamicModal';
                let modal = document.getElementById(modalId);
                
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = modalId;
                    modal.className = 'modal fade';
                    modal.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                                    <h5 class="modal-title text-gradient"></h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body"></div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                modal.querySelector('.modal-title').textContent = title;
                modal.querySelector('.modal-body').innerHTML = content;
                
                new bootstrap.Modal(modal).show();
            }
            
            createAIAnalysisForm() {
                return `
                    <form onsubmit="app.handleAIAnalysis(event)">
                        <div class="mb-3">
                            <label class="form-label">Target URL</label>
                            <input type="url" class="form-control" name="target_url" required 
                                   placeholder="https://example.com">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">AI Provider</label>
                            <select class="form-control" name="ai_provider">
                                <option value="auto">Auto (Best Available)</option>
                                {% for provider, config in ai_providers.items() %}
                                    {% if config.available %}
                                    <option value="{{ provider }}">{{ provider.title() }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Analysis Options</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="deep_scan" id="deep_scan">
                                <label class="form-check-label" for="deep_scan">
                                    Deep Scan (Takes longer, more thorough)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="generate_poc" id="generate_poc" checked>
                                <label class="form-check-label" for="generate_poc">
                                    Generate Proof of Concept
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-robot me-2"></i>Start AI Analysis
                            </button>
                        </div>
                    </form>
                `;
            }
            
            handleAIAnalysis(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('dynamicModal')).hide();
                
                // Start analysis
                this.startAnalysis(data.target_url, {
                    aiProvider: data.ai_provider,
                    deepScan: data.deep_scan === 'on',
                    generatePoc: data.generate_poc === 'on'
                });
            }
            
            animateCounters() {
                const counters = document.querySelectorAll('.stat-number');
                counters.forEach(counter => {
                    const target = parseInt(counter.textContent) || 0;
                    let current = 0;
                    const increment = target / 50;
                    
                    const updateCounter = () => {
                        current += increment;
                        if (current < target) {
                            counter.textContent = Math.floor(current);
                            requestAnimationFrame(updateCounter);
                        } else {
                            counter.textContent = target;
                        }
                    };
                    
                    updateCounter();
                });
            }
            
            updateSystemStats() {
                // Simulate system stats update
                const cpuElement = document.getElementById('cpu-usage');
                if (cpuElement) {
                    const randomCpu = (Math.random() * 30 + 10).toFixed(1);
                    cpuElement.textContent = `${randomCpu}%`;
                }
            }
            
            updateVulnerabilityCounters() {
                // Update vulnerability counters on dashboard
                // This would fetch fresh data from the API
                axios.get('/api/stats')
                    .then(response => {
                        const stats = response.data;
                        // Update UI elements with new stats
                        console.log('Stats updated:', stats);
                    })
                    .catch(error => {
                        console.error('Failed to update stats:', error);
                    });
            }
        }
        
        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new VulnAnalyzerApp();
        });
        
        // Expose global functions
        window.startAnalysis = (url, options) => window.app.startAnalysis(url, options);
        window.exportVulnerabilities = (ids, format) => window.app.exportVulnerabilities(ids, format);
    </script>
    
    <!-- Additional JavaScript from child templates -->
    {% block extra_js %}{% endblock %}
</body>
</html>
