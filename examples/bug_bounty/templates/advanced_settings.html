{% extends "advanced_base.html" %}

{% block title %}Settings | Bug Bounty Pro{% endblock %}

{% block content %}
<div class="content-header">
    <div class="header-section">
        <h1><i class="fas fa-cog"></i> System Settings</h1>
        <p class="subtitle">Configure your bug bounty platform settings and preferences</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-success" onclick="saveAllSettings()">
            <i class="fas fa-save"></i> Save All Changes
        </button>
        <button class="btn btn-secondary" onclick="resetToDefaults()">
            <i class="fas fa-undo"></i> Reset to Defaults
        </button>
    </div>
</div>

<div class="row g-4">
    <!-- Settings Navigation -->
    <div class="col-lg-3">
        <div class="settings-nav">
            <div class="nav-section">
                <h6>General</h6>
                <a href="#general" class="nav-item active" data-section="general">
                    <i class="fas fa-home"></i> General Settings
                </a>
                <a href="#ai" class="nav-item" data-section="ai">
                    <i class="fas fa-brain"></i> AI Configuration
                </a>
                <a href="#database" class="nav-item" data-section="database">
                    <i class="fas fa-database"></i> Database
                </a>
            </div>
            <div class="nav-section">
                <h6>Security</h6>
                <a href="#security" class="nav-item" data-section="security">
                    <i class="fas fa-shield-alt"></i> Security Settings
                </a>
                <a href="#authentication" class="nav-item" data-section="authentication">
                    <i class="fas fa-key"></i> Authentication
                </a>
            </div>
            <div class="nav-section">
                <h6>Reporting</h6>
                <a href="#reports" class="nav-item" data-section="reports">
                    <i class="fas fa-file-alt"></i> Report Settings
                </a>
                <a href="#notifications" class="nav-item" data-section="notifications">
                    <i class="fas fa-bell"></i> Notifications
                </a>
            </div>
            <div class="nav-section">
                <h6>Advanced</h6>
                <a href="#integrations" class="nav-item" data-section="integrations">
                    <i class="fas fa-puzzle-piece"></i> Integrations
                </a>
                <a href="#backup" class="nav-item" data-section="backup">
                    <i class="fas fa-cloud-upload-alt"></i> Backup & Restore
                </a>
                <a href="#logs" class="nav-item" data-section="logs">
                    <i class="fas fa-list-alt"></i> Logs & Debugging
                </a>
            </div>
        </div>
    </div>

    <!-- Settings Content -->
    <div class="col-lg-9">
        <!-- General Settings -->
        <div class="settings-section active" id="general">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-home"></i> General Settings</h5>
                </div>
                <div class="card-body">
                    <form id="generalSettingsForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Application Name</label>
                                <input type="text" class="form-control" name="app_name" value="Bug Bounty Pro">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Environment</label>
                                <select class="form-select" name="environment">
                                    <option value="development">Development</option>
                                    <option value="testing">Testing</option>
                                    <option value="production">Production</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Default Timezone</label>
                                <select class="form-select" name="timezone">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time</option>
                                    <option value="America/Chicago">Central Time</option>
                                    <option value="America/Denver">Mountain Time</option>
                                    <option value="America/Los_Angeles">Pacific Time</option>
                                    <option value="Europe/London">London</option>
                                    <option value="Europe/Berlin">Berlin</option>
                                    <option value="Asia/Tokyo">Tokyo</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Language</label>
                                <select class="form-select" name="language">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ja">Japanese</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Application Description</label>
                                <textarea class="form-control" name="app_description" rows="3">Advanced bug bounty platform with AI-powered vulnerability analysis and comprehensive reporting capabilities.</textarea>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="debugMode" name="debug_mode">
                                    <label class="form-check-label" for="debugMode">
                                        Enable Debug Mode
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="maintenanceMode" name="maintenance_mode">
                                    <label class="form-check-label" for="maintenanceMode">
                                        Maintenance Mode
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- AI Configuration -->
        <div class="settings-section" id="ai">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-brain"></i> AI Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="aiSettingsForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    Configure AI models and API keys for enhanced vulnerability analysis and report generation.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Google Gemini API Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" name="gemini_api_key" placeholder="Enter your Gemini API key">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword(this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">Required for AI-powered vulnerability analysis</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">OpenAI API Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" name="openai_api_key" placeholder="Enter your OpenAI API key">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword(this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">Optional: For alternative AI analysis</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Default AI Model</label>
                                <select class="form-select" name="default_ai_model">
                                    <option value="gemini-pro">Gemini Pro</option>
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">AI Temperature</label>
                                <input type="range" class="form-range" name="ai_temperature" min="0" max="1" step="0.1" value="0.7">
                                <div class="d-flex justify-content-between">
                                    <small>Conservative</small>
                                    <small>Creative</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Max Tokens</label>
                                <input type="number" class="form-control" name="max_tokens" value="2048" min="100" max="8192">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Analysis Timeout (seconds)</label>
                                <input type="number" class="form-control" name="analysis_timeout" value="120" min="30" max="600">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableAiAnalysis" name="enable_ai_analysis" checked>
                                    <label class="form-check-label" for="enableAiAnalysis">
                                        Enable AI-Powered Analysis
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableAiReports" name="enable_ai_reports" checked>
                                    <label class="form-check-label" for="enableAiReports">
                                        Enable AI Report Generation
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-primary" onclick="testAiConnection()">
                                    <i class="fas fa-bolt"></i> Test AI Connection
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Database Settings -->
        <div class="settings-section" id="database">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-database"></i> Database Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="databaseSettingsForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Changing database settings requires application restart. Make sure to backup your data first.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Database Type</label>
                                <select class="form-select" name="db_type">
                                    <option value="sqlite">SQLite (Default)</option>
                                    <option value="postgresql">PostgreSQL</option>
                                    <option value="mysql">MySQL</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Database Name</label>
                                <input type="text" class="form-control" name="db_name" value="bb_pro.db">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Host</label>
                                <input type="text" class="form-control" name="db_host" value="localhost" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Port</label>
                                <input type="number" class="form-control" name="db_port" value="5432" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" name="db_username" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" name="db_password" disabled>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableWal" name="enable_wal" checked>
                                    <label class="form-check-label" for="enableWal">
                                        Enable WAL Mode (SQLite only)
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary" onclick="testDbConnection()">
                                        <i class="fas fa-plug"></i> Test Connection
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="optimizeDatabase()">
                                        <i class="fas fa-tachometer-alt"></i> Optimize Database
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="showDbStats()">
                                        <i class="fas fa-chart-bar"></i> Database Statistics
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="settings-section" id="security">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-shield-alt"></i> Security Settings</h5>
                </div>
                <div class="card-body">
                    <form id="securitySettingsForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-control" name="session_timeout" value="60" min="5" max="480">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Max Login Attempts</label>
                                <input type="number" class="form-control" name="max_login_attempts" value="5" min="1" max="20">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Password Min Length</label>
                                <input type="number" class="form-control" name="password_min_length" value="8" min="4" max="64">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">API Rate Limit (requests/hour)</label>
                                <input type="number" class="form-control" name="api_rate_limit" value="1000" min="10" max="10000">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableTwoFactor" name="enable_2fa">
                                    <label class="form-check-label" for="enableTwoFactor">
                                        Enable Two-Factor Authentication
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enablePasswordComplexity" name="password_complexity" checked>
                                    <label class="form-check-label" for="enablePasswordComplexity">
                                        Require Password Complexity
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableAuditLog" name="enable_audit_log" checked>
                                    <label class="form-check-label" for="enableAuditLog">
                                        Enable Audit Logging
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Report Settings -->
        <div class="settings-section" id="reports">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-file-alt"></i> Report Settings</h5>
                </div>
                <div class="card-body">
                    <form id="reportSettingsForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Default Report Format</label>
                                <select class="form-select" name="default_report_format">
                                    <option value="PDF">PDF</option>
                                    <option value="HTML">HTML</option>
                                    <option value="DOCX">Word Document</option>
                                    <option value="JSON">JSON</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Report Template</label>
                                <select class="form-select" name="report_template">
                                    <option value="professional">Professional</option>
                                    <option value="technical">Technical</option>
                                    <option value="executive">Executive</option>
                                    <option value="minimal">Minimal</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-control" name="company_name" value="Bug Bounty Pro">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Company Logo URL</label>
                                <input type="url" class="form-control" name="company_logo" placeholder="https://example.com/logo.png">
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="includeCharts" name="include_charts" checked>
                                    <label class="form-check-label" for="includeCharts">
                                        Include Charts in Reports
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="includePoc" name="include_poc" checked>
                                    <label class="form-check-label" for="includePoc">
                                        Include Proof of Concepts
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoGenerateReports" name="auto_generate_reports">
                                    <label class="form-check-label" for="autoGenerateReports">
                                        Auto-generate Reports for New Vulnerabilities
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Backup & Restore -->
        <div class="settings-section" id="backup">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cloud-upload-alt"></i> Backup & Restore</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6>Database Backup</h6>
                            <p class="text-muted">Create a backup of your vulnerability database</p>
                            <button class="btn btn-success w-100" onclick="createBackup()">
                                <i class="fas fa-download"></i> Create Backup
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>Restore Database</h6>
                            <p class="text-muted">Restore from a previous backup file</p>
                            <input type="file" class="form-control mb-2" accept=".db,.sql" id="restoreFile">
                            <button class="btn btn-warning w-100" onclick="restoreBackup()">
                                <i class="fas fa-upload"></i> Restore Backup
                            </button>
                        </div>
                        <div class="col-12">
                            <h6>Automatic Backups</h6>
                            <form id="backupScheduleForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableAutoBackup" name="enable_auto_backup">
                                            <label class="form-check-label" for="enableAutoBackup">
                                                Enable Automatic Backups
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-select" name="backup_frequency">
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize settings navigation
    initializeNavigation();
    
    // Load current settings
    loadSettings();
    
    // Initialize form handlers
    initializeFormHandlers();
});

function initializeNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.settings-section');
    
    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update navigation
            navItems.forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            
            // Update sections
            sections.forEach(section => section.classList.remove('active'));
            const targetSection = document.getElementById(this.dataset.section);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        });
    });
}

function loadSettings() {
    // Load settings from backend
    fetch('/api/settings')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateSettings(data.settings);
        }
    })
    .catch(error => {
        console.error('Failed to load settings:', error);
    });
}

function populateSettings(settings) {
    // Populate form fields with current settings
    Object.keys(settings).forEach(key => {
        const input = document.querySelector(`[name="${key}"]`);
        if (input) {
            if (input.type === 'checkbox') {
                input.checked = settings[key];
            } else {
                input.value = settings[key];
            }
        }
    });
}

function initializeFormHandlers() {
    // Database type change handler
    const dbTypeSelect = document.querySelector('[name="db_type"]');
    if (dbTypeSelect) {
        dbTypeSelect.addEventListener('change', function() {
            const isNotSqlite = this.value !== 'sqlite';
            const dbFields = ['db_host', 'db_port', 'db_username', 'db_password'];
            
            dbFields.forEach(field => {
                const input = document.querySelector(`[name="${field}"]`);
                if (input) {
                    input.disabled = !isNotSqlite;
                }
            });
        });
    }
}

function saveAllSettings() {
    const allSettings = {};
    const forms = document.querySelectorAll('form[id$="SettingsForm"]');
    
    forms.forEach(form => {
        const formData = new FormData(form);
        for (let [key, value] of formData.entries()) {
            allSettings[key] = value;
        }
    });
    
    // Handle checkboxes separately
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        allSettings[checkbox.name] = checkbox.checked;
    });
    
    fetch('/api/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(allSettings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Settings saved successfully', 'success');
        } else {
            showAlert('Failed to save settings: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Failed to save settings: ' + error.message, 'danger');
    });
}

function resetToDefaults() {
    if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
        fetch('/api/settings/reset', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Settings reset to defaults', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('Failed to reset settings', 'danger');
            }
        });
    }
}

function togglePassword(button) {
    const input = button.previousElementSibling;
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function testAiConnection() {
    const apiKey = document.querySelector('[name="gemini_api_key"]').value;
    
    if (!apiKey) {
        showAlert('Please enter a Gemini API key first', 'warning');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    fetch('/api/test_ai_connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({api_key: apiKey})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('AI connection successful', 'success');
        } else {
            showAlert('AI connection failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('AI connection test failed: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function testDbConnection() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    fetch('/api/test_db_connection', {method: 'POST'})
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Database connection successful', 'success');
        } else {
            showAlert('Database connection failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Database test failed: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function optimizeDatabase() {
    if (confirm('This will optimize the database and may take a few minutes. Continue?')) {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Optimizing...';
        btn.disabled = true;
        
        fetch('/api/optimize_database', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Database optimized successfully', 'success');
            } else {
                showAlert('Database optimization failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Database optimization failed: ' + error.message, 'danger');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
}

function showDbStats() {
    fetch('/api/database_stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const stats = data.stats;
            const modal = `
                <div class="modal fade" id="dbStatsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Database Statistics</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="stat-item">
                                            <span class="stat-label">Vulnerabilities:</span>
                                            <span class="stat-value">${stats.vulnerabilities || 0}</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-item">
                                            <span class="stat-label">Targets:</span>
                                            <span class="stat-value">${stats.targets || 0}</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-item">
                                            <span class="stat-label">Reports:</span>
                                            <span class="stat-value">${stats.reports || 0}</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-item">
                                            <span class="stat-label">Database Size:</span>
                                            <span class="stat-value">${stats.size || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
            new bootstrap.Modal(document.getElementById('dbStatsModal')).show();
        }
    });
}

function createBackup() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    btn.disabled = true;
    
    fetch('/api/create_backup', {method: 'POST'})
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bb_pro_backup_${new Date().toISOString().split('T')[0]}.db`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showAlert('Backup created successfully', 'success');
    })
    .catch(error => {
        showAlert('Backup creation failed: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function restoreBackup() {
    const fileInput = document.getElementById('restoreFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Please select a backup file first', 'warning');
        return;
    }
    
    if (confirm('This will replace your current database. Are you sure? Make sure to create a backup first.')) {
        const formData = new FormData();
        formData.append('backup_file', file);
        
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restoring...';
        btn.disabled = true;
        
        fetch('/api/restore_backup', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Backup restored successfully', 'success');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                showAlert('Backup restoration failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Backup restoration failed: ' + error.message, 'danger');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    setTimeout(() => {
        const alert = document.querySelector('.alert:last-child');
        if (alert) alert.remove();
    }, 5000);
}
</script>

<style>
.settings-nav {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: sticky;
    top: 2rem;
}

.nav-section {
    margin-bottom: 2rem;
}

.nav-section:last-child {
    margin-bottom: 0;
}

.nav-section h6 {
    color: #6c757d;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
    font-weight: 600;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: #adb5bd;
    text-decoration: none;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.nav-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
}

.nav-item.active {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: #ffffff;
}

.nav-item i {
    width: 16px;
    text-align: center;
}

.settings-section {
    display: none;
}

.settings-section.active {
    display: block;
}

.card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
}

.card-header {
    background: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px 16px 0 0;
}

.card-header h5 {
    color: #ffffff;
    margin: 0;
    font-weight: 600;
}

.form-label {
    color: #ffffff;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-control,
.form-select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #ffffff;
}

.form-control:focus,
.form-select:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    color: #ffffff;
}

.form-control::placeholder {
    color: #6c757d;
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.form-check-label {
    color: #ffffff;
}

.form-text {
    color: #6c757d;
}

.alert {
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
}

.alert-info {
    background: rgba(23, 162, 184, 0.1);
    border-color: rgba(23, 162, 184, 0.2);
    color: #b3ecf2;
}

.alert-warning {
    background: rgba(255, 193, 7, 0.1);
    border-color: rgba(255, 193, 7, 0.2);
    color: #fff3cd;
}

.input-group-text {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #adb5bd;
}

.form-range {
    background: transparent;
}

.form-range::-webkit-slider-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.form-range::-webkit-slider-thumb {
    background: #007bff;
}

.form-range::-moz-range-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.form-range::-moz-range-thumb {
    background: #007bff;
    border: none;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #adb5bd;
    font-weight: 500;
}

.stat-value {
    color: #ffffff;
    font-weight: 600;
}

@media (max-width: 992px) {
    .settings-nav {
        position: static;
        margin-bottom: 2rem;
    }
    
    .nav-section {
        margin-bottom: 1rem;
    }
    
    .nav-item {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
}
</style>
{% endblock %}
