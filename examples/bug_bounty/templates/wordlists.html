{% extends "base.html" %}

{% block title %}Wordlists Management - Bug Bounty Hunter Pro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-list"></i> Wordlists Management</h1>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWordlistModal">
            <i class="fas fa-plus"></i> Add Wordlist
        </button>
        <button class="btn btn-success" onclick="downloadRecommended()">
            <i class="fas fa-download"></i> Download Recommended
        </button>
    </div>
</div>

<!-- Wordlists Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ wordlists|length }}</h3>
                <p class="mb-0">Total Wordlists</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ wordlists|selectattr("2", "equalto", "directory")|list|length }}</h3>
                <p class="mb-0">Directory Lists</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ wordlists|selectattr("2", "equalto", "subdomain")|list|length }}</h3>
                <p class="mb-0">Subdomain Lists</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h3>{{ wordlists|selectattr("2", "equalto", "password")|list|length }}</h3>
                <p class="mb-0">Password Lists</p>
            </div>
        </div>
    </div>
</div>

<!-- Wordlists Table -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-table"></i> Available Wordlists</h5>
        <div class="float-end">
            <select class="form-select form-select-sm" id="categoryFilter" onchange="filterWordlists()">
                <option value="">All Categories</option>
                <option value="directory">Directory Bruteforce</option>
                <option value="subdomain">Subdomain Enumeration</option>
                <option value="password">Password Lists</option>
                <option value="username">Username Lists</option>
                <option value="fuzzing">Fuzzing</option>
                <option value="api">API Endpoints</option>
                <option value="parameter">Parameter Names</option>
                <option value="technology">Technology-Specific</option>
                <option value="custom">Custom Lists</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        {% if wordlists %}
            <div class="table-responsive">
                <table class="table table-striped" id="wordlistTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Word Count</th>
                            <th>Effectiveness</th>
                            <th>File Size</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for wordlist in wordlists %}
                        <tr data-category="{{ wordlist[2] }}">
                            <td>
                                <strong>{{ wordlist[1] }}</strong>
                                <br>
                                <small class="text-muted">{{ wordlist[3] }}</small>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if wordlist[2] == 'directory' %}bg-success
                                    {% elif wordlist[2] == 'subdomain' %}bg-info
                                    {% elif wordlist[2] == 'password' %}bg-warning
                                    {% elif wordlist[2] == 'username' %}bg-primary
                                    {% elif wordlist[2] == 'fuzzing' %}bg-danger
                                    {% elif wordlist[2] == 'api' %}bg-secondary
                                    {% else %}bg-dark{% endif %}">
                                    {{ wordlist[2]|title }}
                                </span>
                            </td>
                            <td>
                                <strong>{{ "{:,}".format(wordlist[4] or 0) }}</strong> words
                            </td>
                            <td>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar 
                                        {% if wordlist[5] >= 80 %}bg-success
                                        {% elif wordlist[5] >= 60 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                        role="progressbar" 
                                        style="width: {{ wordlist[5] or 0 }}%">
                                        {{ wordlist[5] or 0 }}%
                                    </div>
                                </div>
                            </td>
                            <td id="filesize-{{ wordlist[0] }}">Calculating...</td>
                            <td>{{ wordlist[6] }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="previewWordlist({{ wordlist[0] }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="downloadWordlist({{ wordlist[0] }})">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="useWordlist({{ wordlist[0] }})">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="editWordlist({{ wordlist[0] }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteWordlist({{ wordlist[0] }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-list fa-3x text-muted mb-3"></i>
                <h4>No Wordlists Available</h4>
                <p class="text-muted">Start by adding or downloading some wordlists</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWordlistModal">
                    <i class="fas fa-plus"></i> Add Wordlist
                </button>
                <button class="btn btn-success ms-2" onclick="downloadRecommended()">
                    <i class="fas fa-download"></i> Download Recommended
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Wordlist Modal -->
<div class="modal fade" id="addWordlistModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Wordlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="addWordlistTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button">
                            <i class="fas fa-upload"></i> Upload File
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url" type="button">
                            <i class="fas fa-link"></i> From URL
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button">
                            <i class="fas fa-edit"></i> Manual Entry
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="addWordlistTabContent">
                    <!-- Upload Tab -->
                    <div class="tab-pane fade show active" id="upload" role="tabpanel">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label class="form-label">Wordlist Name</label>
                                <input type="text" class="form-control" id="uploadName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="uploadCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="directory">Directory Bruteforce</option>
                                    <option value="subdomain">Subdomain Enumeration</option>
                                    <option value="password">Password Lists</option>
                                    <option value="username">Username Lists</option>
                                    <option value="fuzzing">Fuzzing</option>
                                    <option value="api">API Endpoints</option>
                                    <option value="parameter">Parameter Names</option>
                                    <option value="technology">Technology-Specific</option>
                                    <option value="custom">Custom Lists</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">File</label>
                                <input type="file" class="form-control" id="wordlistFile" accept=".txt,.lst,.dic,.wordlist" required>
                                <div class="form-text">Supported formats: .txt, .lst, .dic, .wordlist</div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- URL Tab -->
                    <div class="tab-pane fade" id="url" role="tabpanel">
                        <form id="urlForm">
                            <div class="mb-3">
                                <label class="form-label">Wordlist Name</label>
                                <input type="text" class="form-control" id="urlName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="urlCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="directory">Directory Bruteforce</option>
                                    <option value="subdomain">Subdomain Enumeration</option>
                                    <option value="password">Password Lists</option>
                                    <option value="username">Username Lists</option>
                                    <option value="fuzzing">Fuzzing</option>
                                    <option value="api">API Endpoints</option>
                                    <option value="parameter">Parameter Names</option>
                                    <option value="technology">Technology-Specific</option>
                                    <option value="custom">Custom Lists</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Download URL</label>
                                <input type="url" class="form-control" id="wordlistUrl" required 
                                       placeholder="https://example.com/wordlist.txt">
                            </div>
                        </form>
                    </div>
                    
                    <!-- Manual Tab -->
                    <div class="tab-pane fade" id="manual" role="tabpanel">
                        <form id="manualForm">
                            <div class="mb-3">
                                <label class="form-label">Wordlist Name</label>
                                <input type="text" class="form-control" id="manualName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="manualCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="directory">Directory Bruteforce</option>
                                    <option value="subdomain">Subdomain Enumeration</option>
                                    <option value="password">Password Lists</option>
                                    <option value="username">Username Lists</option>
                                    <option value="fuzzing">Fuzzing</option>
                                    <option value="api">API Endpoints</option>
                                    <option value="parameter">Parameter Names</option>
                                    <option value="technology">Technology-Specific</option>
                                    <option value="custom">Custom Lists</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Words (one per line)</label>
                                <textarea class="form-control bg-dark text-light" id="manualWords" rows="10" 
                                          placeholder="admin&#10;administrator&#10;login&#10;dashboard&#10;panel"></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addWordlist()">
                    <i class="fas fa-save"></i> Add Wordlist
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Wordlist Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function filterWordlists() {
    const filter = document.getElementById('categoryFilter').value;
    const rows = document.querySelectorAll('#wordlistTable tbody tr');
    
    rows.forEach(row => {
        const category = row.getAttribute('data-category');
        if (!filter || category === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function previewWordlist(wordlistId) {
    fetch(`/api/preview_wordlist/${wordlistId}`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('previewContent');
            
            if (data.preview) {
                content.innerHTML = `
                    <div class="mb-3">
                        <h6>${data.name}</h6>
                        <p class="text-muted">${data.category} • ${data.word_count.toLocaleString()} words</p>
                    </div>
                    <div class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                        <pre>${data.preview}</pre>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            Showing first 50 lines. Total: ${data.word_count.toLocaleString()} words
                        </small>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load wordlist preview: ${data.error || 'Unknown error'}
                    </div>
                `;
            }
            
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        })
        .catch(error => {
            console.error('Error loading preview:', error);
        });
}

function downloadWordlist(wordlistId) {
    window.location.href = `/api/download_wordlist/${wordlistId}`;
}

function useWordlist(wordlistId) {
    // Redirect to scan page with wordlist pre-selected
    window.location.href = `/scan_with_wordlist/${wordlistId}`;
}

function editWordlist(wordlistId) {
    window.location.href = `/edit_wordlist/${wordlistId}`;
}

function deleteWordlist(wordlistId) {
    if (confirm('Are you sure you want to delete this wordlist? This action cannot be undone.')) {
        fetch(`/api/delete_wordlist/${wordlistId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Wordlist deleted successfully!', 'success');
                    location.reload();
                } else {
                    showAlert('Failed to delete wordlist: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                showAlert('Error deleting wordlist: ' + error.message, 'danger');
            });
    }
}

function addWordlist() {
    const activeTab = document.querySelector('#addWordlistTabs .nav-link.active').id;
    
    if (activeTab === 'upload-tab') {
        addWordlistFromUpload();
    } else if (activeTab === 'url-tab') {
        addWordlistFromUrl();
    } else if (activeTab === 'manual-tab') {
        addWordlistFromManual();
    }
}

function addWordlistFromUpload() {
    const name = document.getElementById('uploadName').value;
    const category = document.getElementById('uploadCategory').value;
    const file = document.getElementById('wordlistFile').files[0];
    
    if (!name || !category || !file) {
        showAlert('Please fill in all required fields', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('category', category);
    formData.append('file', file);
    
    fetch('/api/add_wordlist_upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Wordlist uploaded successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addWordlistModal')).hide();
            location.reload();
        } else {
            showAlert('Failed to upload wordlist: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Error uploading wordlist: ' + error.message, 'danger');
    });
}

function addWordlistFromUrl() {
    const name = document.getElementById('urlName').value;
    const category = document.getElementById('urlCategory').value;
    const url = document.getElementById('wordlistUrl').value;
    
    if (!name || !category || !url) {
        showAlert('Please fill in all required fields', 'warning');
        return;
    }
    
    fetch('/api/add_wordlist_url', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            category: category,
            url: url
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Wordlist downloaded successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addWordlistModal')).hide();
            location.reload();
        } else {
            showAlert('Failed to download wordlist: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Error downloading wordlist: ' + error.message, 'danger');
    });
}

function addWordlistFromManual() {
    const name = document.getElementById('manualName').value;
    const category = document.getElementById('manualCategory').value;
    const words = document.getElementById('manualWords').value;
    
    if (!name || !category || !words.trim()) {
        showAlert('Please fill in all required fields', 'warning');
        return;
    }
    
    fetch('/api/add_wordlist_manual', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            category: category,
            words: words
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Wordlist created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addWordlistModal')).hide();
            location.reload();
        } else {
            showAlert('Failed to create wordlist: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Error creating wordlist: ' + error.message, 'danger');
    });
}

function downloadRecommended() {
    if (confirm('This will download recommended wordlists from SecLists and other sources. Continue?')) {
        fetch('/api/download_recommended_wordlists', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`Downloaded ${data.count} wordlist(s) successfully!`, 'success');
                    location.reload();
                } else {
                    showAlert('Failed to download recommended wordlists: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                showAlert('Error downloading wordlists: ' + error.message, 'danger');
            });
    }
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.d-flex').nextSibling);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Calculate file sizes on page load
document.addEventListener('DOMContentLoaded', function() {
    const fileSizeElements = document.querySelectorAll('[id^="filesize-"]');
    fileSizeElements.forEach(element => {
        const wordlistId = element.id.split('-')[1];
        fetch(`/api/wordlist_filesize/${wordlistId}`)
            .then(response => response.json())
            .then(data => {
                element.textContent = data.size || 'Unknown';
            })
            .catch(() => {
                element.textContent = 'Unknown';
            });
    });
});
</script>
{% endblock %}
