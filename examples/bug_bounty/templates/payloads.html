{% extends "base.html" %}

{% block title %}Payload Management - Bug Bounty Hunter Pro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-code"></i> Payload Management</h1>
    <div>
        <a href="{{ url_for('add_payload') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Payload
        </a>
        <button class="btn btn-success" onclick="importPayloads()">
            <i class="fas fa-upload"></i> Import
        </button>
        <button class="btn btn-info" onclick="exportPayloads()">
            <i class="fas fa-download"></i> Export
        </button>
    </div>
</div>

<!-- Payload Categories -->
{% for category, payloads in payload_categories.items() %}
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-folder"></i> {{ category|title }} Payloads</h5>
        <small class="text-muted">{{ payloads|length }} payload(s) available</small>
    </div>
    <div class="card-body">
        <div class="row">
            {% for payload in payloads %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card payload-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">{{ payload[1] }}</h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="copyPayload({{ payload[0] }})">
                                    <i class="fas fa-copy"></i> Copy
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="testPayload({{ payload[0] }})">
                                    <i class="fas fa-play"></i> Test
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="editPayload({{ payload[0] }})">
                                    <i class="fas fa-edit"></i> Edit
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deletePayload({{ payload[0] }})">
                                    <i class="fas fa-trash"></i> Delete
                                </a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">{{ payload[4] or 'No description available' }}</p>
                        <div class="code-preview bg-dark text-light p-2 rounded mb-2">
                            <code>{{ payload[3][:100] }}{% if payload[3]|length > 100 %}...{% endif %}</code>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-success">{{ payload[5] or 0 }}% Success</span>
                                {% if payload[6] %}
                                    {% for tag in payload[6].split(',') %}
                                        <span class="badge bg-secondary">{{ tag.strip() }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ payload[7] }}</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endfor %}

{% if not payload_categories %}
<div class="text-center py-5">
    <i class="fas fa-code fa-3x text-muted mb-3"></i>
    <h4>No Payloads Available</h4>
    <p class="text-muted">Get started by adding your first payload</p>
    <a href="{{ url_for('add_payload') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add Your First Payload
    </a>
</div>
{% endif %}

<!-- Payload Test Modal -->
<div class="modal fade" id="testPayloadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Payload</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testPayloadForm">
                    <div class="mb-3">
                        <label class="form-label">Target URL</label>
                        <input type="url" class="form-control" id="testUrl" placeholder="https://example.com" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parameter</label>
                        <input type="text" class="form-control" id="testParam" placeholder="id, q, search, etc.">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Method</label>
                        <select class="form-select" id="testMethod">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payload Preview</label>
                        <textarea class="form-control bg-dark text-light" id="payloadPreview" rows="4" readonly></textarea>
                    </div>
                </form>
                <div id="testResults" class="mt-3" style="display: none;">
                    <h6>Test Results:</h6>
                    <div class="bg-light p-3 rounded">
                        <div id="testOutput"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="runPayloadTest()">
                    <i class="fas fa-play"></i> Run Test
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.payload-card {
    transition: transform 0.2s;
    border: 1px solid #3a3a3a;
    background: linear-gradient(135deg, #2a2a2a, #1e1e1e);
}

.payload-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.code-preview {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    max-height: 60px;
    overflow: hidden;
}
</style>

<script>
let currentPayloadId = null;

function copyPayload(payloadId) {
    // Get payload content and copy to clipboard
    fetch(`/api/get_payload/${payloadId}`)
        .then(response => response.json())
        .then(data => {
            if (data.payload_code) {
                navigator.clipboard.writeText(data.payload_code).then(() => {
                    showAlert('Payload copied to clipboard!', 'success');
                });
            }
        })
        .catch(error => {
            showAlert('Failed to copy payload', 'danger');
        });
}

function testPayload(payloadId) {
    currentPayloadId = payloadId;
    
    // Load payload data
    fetch(`/api/get_payload/${payloadId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('payloadPreview').value = data.payload_code;
            document.getElementById('testResults').style.display = 'none';
        });
    
    // Show modal
    new bootstrap.Modal(document.getElementById('testPayloadModal')).show();
}

function runPayloadTest() {
    const url = document.getElementById('testUrl').value;
    const param = document.getElementById('testParam').value;
    const method = document.getElementById('testMethod').value;
    
    if (!url) {
        showAlert('Please enter a target URL', 'warning');
        return;
    }
    
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    // Simulate payload test (in real implementation, this would be server-side)
    setTimeout(() => {
        const results = {
            status: 'completed',
            response_code: Math.random() > 0.5 ? 200 : 404,
            response_time: Math.floor(Math.random() * 1000) + 100,
            payload_reflected: Math.random() > 0.7,
            potential_vulnerability: Math.random() > 0.8
        };
        
        displayTestResults(results);
        
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
}

function displayTestResults(results) {
    const output = document.getElementById('testOutput');
    const resultsDiv = document.getElementById('testResults');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <strong>Response Code:</strong> 
                <span class="badge ${results.response_code === 200 ? 'bg-success' : 'bg-danger'}">
                    ${results.response_code}
                </span>
            </div>
            <div class="col-md-6">
                <strong>Response Time:</strong> ${results.response_time}ms
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-6">
                <strong>Payload Reflected:</strong> 
                <span class="badge ${results.payload_reflected ? 'bg-warning' : 'bg-success'}">
                    ${results.payload_reflected ? 'Yes' : 'No'}
                </span>
            </div>
            <div class="col-md-6">
                <strong>Potential Vulnerability:</strong> 
                <span class="badge ${results.potential_vulnerability ? 'bg-danger' : 'bg-success'}">
                    ${results.potential_vulnerability ? 'Detected' : 'None'}
                </span>
            </div>
        </div>
    `;
    
    if (results.potential_vulnerability) {
        html += `
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Potential vulnerability detected!</strong> 
                Review the response manually and consider reporting this finding.
            </div>
        `;
    }
    
    output.innerHTML = html;
    resultsDiv.style.display = 'block';
}

function editPayload(payloadId) {
    // Redirect to edit page (would need to be implemented)
    window.location.href = `/edit_payload/${payloadId}`;
}

function deletePayload(payloadId) {
    if (confirm('Are you sure you want to delete this payload?')) {
        fetch(`/api/delete_payload/${payloadId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Payload deleted successfully', 'success');
                    location.reload();
                } else {
                    showAlert('Failed to delete payload', 'danger');
                }
            });
    }
}

function importPayloads() {
    // Create file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.txt,.csv';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/import_payloads', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`Imported ${data.count} payload(s) successfully`, 'success');
                    location.reload();
                } else {
                    showAlert('Failed to import payloads', 'danger');
                }
            });
        }
    };
    input.click();
}

function exportPayloads() {
    window.location.href = '/api/export_payloads';
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.d-flex').nextSibling);
}
</script>
{% endblock %}
