{% extends "advanced_base.html" %}

{% block page_title %}Security Dashboard{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card total-stat">
            <div class="stat-card-content">
                <div class="stat-value">{{ total_vulns }}</div>
                <div class="stat-label">Total Vulnerabilities</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card critical-stat">
            <div class="stat-card-content">
                <div class="stat-value">{{ severity_counts.get('Critical', 0) }}</div>
                <div class="stat-label">Critical</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card high-stat">
            <div class="stat-card-content">
                <div class="stat-value">{{ severity_counts.get('High', 0) }}</div>
                <div class="stat-label">High</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card medium-stat">
            <div class="stat-card-content">
                <div class="stat-value">{{ severity_counts.get('Medium', 0) }}</div>
                <div class="stat-label">Medium</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card low-stat">
            <div class="stat-card-content">
                <div class="stat-value">{{ severity_counts.get('Low', 0) }}</div>
                <div class="stat-label">Low</div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card" style="background: linear-gradient(45deg, #8b5cf6, #7c3aed);">
            <div class="stat-card-content">
                <div class="stat-value">{{ system_status.reports_count }}</div>
                <div class="stat-label">Reports Generated</div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-rocket"></i>
                    Quick Actions
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary w-100" onclick="analyzeAllVulnerabilities()">
                            <i class="fas fa-cogs"></i>
                            Analyze All Vulnerabilities
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-success w-100" onclick="generateBulkReports()">
                            <i class="fas fa-file-export"></i>
                            Generate Bulk Reports
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-warning w-100" onclick="testAIConnection()">
                            <i class="fas fa-robot"></i>
                            Test AI Connection
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('vulnerabilities_list') }}" class="btn btn-info w-100">
                            <i class="fas fa-search"></i>
                            Browse Vulnerabilities
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Analytics -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    Vulnerability Types Distribution
                </h3>
            </div>
            <div class="card-body">
                <canvas id="typeChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Severity Breakdown
                </h3>
            </div>
            <div class="card-body">
                <canvas id="severityChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Vulnerabilities -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">
                    <i class="fas fa-bug"></i>
                    Recent Vulnerabilities
                </h3>
                <a href="{{ url_for('vulnerabilities_list') }}" class="btn btn-outline-primary">
                    View All <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            <div class="card-body p-0">
                {% if vulnerabilities %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Target</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vuln in vulnerabilities %}
                            <tr>
                                <td>
                                    <strong>#{{ vuln.id }}</strong>
                                </td>
                                <td>
                                    <a href="{{ url_for('vulnerability_detail', vuln_id=vuln.id) }}" class="text-decoration-none">
                                        {{ vuln.title }}
                                    </a>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ vuln.vuln_type or 'Unknown' }}</span>
                                </td>
                                <td>
                                    <span class="severity-badge severity-{{ vuln.severity.lower() if vuln.severity else 'unknown' }}">
                                        {{ vuln.severity or 'Unknown' }}
                                    </span>
                                </td>
                                <td>{{ vuln.target_name or 'Unknown' }}</td>
                                <td>
                                    <span class="badge {% if vuln.status == 'open' %}bg-danger{% elif vuln.status == 'fixed' %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ vuln.status or 'Open' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="quickAnalyze({{ vuln.id }})" title="Quick Analysis">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="generateReport({{ vuln.id }})" title="Generate Report">
                                            <i class="fas fa-file-alt"></i>
                                        </button>
                                        <a href="{{ url_for('vulnerability_detail', vuln_id=vuln.id) }}" class="btn btn-outline-info" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-bug fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Vulnerabilities Found</h4>
                    <p class="text-muted">Run your bug bounty scanner to discover vulnerabilities.</p>
                    <button class="btn btn-primary" onclick="startScan()">
                        <i class="fas fa-play"></i>
                        Start Vulnerability Scan
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- System Status Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-server"></i>
                    System Status
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator bg-success me-3"></div>
                            <div>
                                <strong>Database</strong><br>
                                <small class="text-muted">{{ system_status.database }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator {% if system_status.ai_available %}bg-success{% else %}bg-danger{% endif %} me-3"></div>
                            <div>
                                <strong>AI Analysis</strong><br>
                                <small class="text-muted">{% if system_status.ai_available %}Available{% else %}Offline{% endif %}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator bg-success me-3"></div>
                            <div>
                                <strong>Analysis Engine</strong><br>
                                <small class="text-muted">Ready</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator bg-success me-3"></div>
                            <div>
                                <strong>Report Generator</strong><br>
                                <small class="text-muted">Operational</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .progress-container {
        margin: 1rem 0;
    }
    
    .analysis-progress {
        display: none;
        margin-top: 1rem;
    }
    
    .analysis-progress.active {
        display: block;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart.js configurations
    const typeData = {
        labels: [{% for type, count in type_counts.items() %}'{{ type }}',{% endfor %}],
        datasets: [{
            data: [{% for type, count in type_counts.items() %}{{ count }},{% endfor %}],
            backgroundColor: [
                '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f59e0b',
                '#10b981', '#3b82f6', '#6b7280', '#8b5a2b', '#7c2d12'
            ],
            borderWidth: 0
        }]
    };

    const severityData = {
        labels: ['Critical', 'High', 'Medium', 'Low'],
        datasets: [{
            data: [
                {{ severity_counts.get('Critical', 0) }},
                {{ severity_counts.get('High', 0) }},
                {{ severity_counts.get('Medium', 0) }},
                {{ severity_counts.get('Low', 0) }}
            ],
            backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981'],
            borderWidth: 0
        }]
    };

    // Initialize charts
    const typeChart = new Chart(document.getElementById('typeChart'), {
        type: 'doughnut',
        data: typeData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    const severityChart = new Chart(document.getElementById('severityChart'), {
        type: 'bar',
        data: severityData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Dashboard functions
    function quickAnalyze(vulnId) {
        showProgress(`Analyzing vulnerability ${vulnId}...`);
        
        axios.get(`/api/analyze/${vulnId}?type=manual`)
            .then(response => {
                hideProgress();
                if (response.data.success) {
                    showSuccess(`Analysis complete for vulnerability ${vulnId}`);
                    setTimeout(() => {
                        window.location.href = `/vulnerability/${vulnId}`;
                    }, 1500);
                } else {
                    showError('Analysis failed: ' + response.data.error);
                }
            })
            .catch(error => {
                hideProgress();
                showError('Analysis failed: ' + error.message);
            });
    }

    function generateReport(vulnId) {
        showProgress(`Generating report for vulnerability ${vulnId}...`);
        
        axios.get(`/api/analyze/${vulnId}?type=ai`)
            .then(response => {
                hideProgress();
                if (response.data.success) {
                    showSuccess(`Report generated for vulnerability ${vulnId}`);
                    setTimeout(() => {
                        window.location.href = `/reports`;
                    }, 1500);
                } else {
                    showError('Report generation failed: ' + response.data.error);
                }
            })
            .catch(error => {
                hideProgress();
                showError('Report generation failed: ' + error.message);
            });
    }

    function analyzeAllVulnerabilities() {
        if (confirm('This will analyze all vulnerabilities and may take several minutes. Continue?')) {
            showProgress('Starting bulk analysis...');
            
            // Implement bulk analysis
            setTimeout(() => {
                hideProgress();
                showSuccess('Bulk analysis initiated. Check the reports section for results.');
            }, 3000);
        }
    }

    function generateBulkReports() {
        if (confirm('Generate reports for all vulnerabilities? This may take several minutes.')) {
            showProgress('Generating bulk reports...');
            
            // Implement bulk report generation
            setTimeout(() => {
                hideProgress();
                showSuccess('Bulk report generation initiated.');
            }, 3000);
        }
    }

    function testAIConnection() {
        showProgress('Testing AI connection...');
        
        axios.get('/api/test-ai')
            .then(response => {
                hideProgress();
                if (response.data.success) {
                    showSuccess('AI connection successful!');
                } else {
                    showError('AI connection failed: ' + response.data.message);
                }
            })
            .catch(error => {
                hideProgress();
                showError('AI connection test failed: ' + error.message);
            });
    }

    function startScan() {
        alert('Vulnerability scanning feature will be integrated with your main bug bounty system.');
    }

    // Utility functions
    function showProgress(message) {
        // Create progress modal or indicator
        const progressHtml = `
            <div id="progressModal" class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center">
                            <div class="loading-spinner mb-3"></div>
                            <h5>${message}</h5>
                            <p class="text-muted">Please wait...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', progressHtml);
    }

    function hideProgress() {
        const modal = document.getElementById('progressModal');
        if (modal) {
            modal.remove();
        }
    }

    function showSuccess(message) {
        showAlert(message, 'success');
    }

    function showError(message) {
        showAlert(message, 'danger');
    }

    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', alertHtml);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                if (alert.textContent.includes(message)) {
                    alert.remove();
                }
            });
        }, 5000);
    }

    // Auto-refresh dashboard every 60 seconds
    setInterval(() => {
        updateDashboardStats();
    }, 60000);

    function updateDashboardStats() {
        axios.get('/api/system-status')
            .then(response => {
                // Update stats if needed
                console.log('Dashboard stats updated');
            })
            .catch(error => {
                console.error('Failed to update dashboard stats:', error);
            });
    }
</script>
{% endblock %}
