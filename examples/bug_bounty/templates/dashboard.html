{% extends "base.html" %}

{% block title %}Dashboard - Bug Bounty Hunter Pro{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Dashboard</h1>
        <p class="text-muted mb-0">Welcome back! Here's what's happening with your bug bounty campaigns.</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="startQuickScan()">
            <i class="fas fa-search"></i> Quick Scan
        </button>
        <button class="btn btn-success" onclick="showAddTargetModal()">
            <i class="fas fa-plus"></i> Add Target
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number">{{ total_targets }}</div>
            <div class="stats-label">Active Targets</div>
            <div class="mt-2">
                <small class="text-success">
                    <i class="fas fa-arrow-up"></i> +2 this week
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number">{{ total_vulnerabilities }}</div>
            <div class="stats-label">Vulnerabilities Found</div>
            <div class="mt-2">
                <small class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i> {{ critical_vulns }} Critical
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number">${{ total_estimated_payout }}</div>
            <div class="stats-label">Estimated Payouts</div>
            <div class="mt-2">
                <small class="text-info">
                    <i class="fas fa-chart-line"></i> +15% this month
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-number">{{ active_scans }}</div>
            <div class="stats-label">Active Scans</div>
            <div class="mt-2">
                <small class="text-warning">
                    <i class="fas fa-clock"></i> 2 pending
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row g-4">
    <!-- Recent Activity -->
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Recent Activity</h5>
                <button class="btn btn-sm btn-outline-primary">View All</button>
            </div>
            <div class="card-body">
                <div class="activity-timeline">
                    {% for activity in recent_activities %}
                    <div class="activity-item d-flex align-items-start mb-3">
                        <div class="activity-icon me-3">
                            <i class="fas {{ activity.icon }} text-{{ activity.color }}"></i>
                        </div>
                        <div class="activity-content flex-grow-1">
                            <div class="activity-title">{{ activity.title }}</div>
                            <div class="activity-description text-muted">{{ activity.description }}</div>
                            <div class="activity-time text-muted small">{{ activity.time }}</div>
                        </div>
                        <div class="activity-action">
                            {% if activity.action %}
                            <button class="btn btn-sm btn-outline-primary">{{ activity.action }}</button>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clock text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No recent activity</h5>
                        <p class="text-muted">Start by adding a target or running a scan</p>
                        <button class="btn btn-primary" onclick="showAddTargetModal()">
                            <i class="fas fa-plus"></i> Add Your First Target
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions & Stats -->
    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-zap"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="window.location.href='{{ url_for('add_target') }}'">
                        <i class="fas fa-crosshairs"></i> Add New Target
                    </button>
                    <button class="btn btn-success" onclick="runFullScan()">
                        <i class="fas fa-search"></i> Run Full Scan
                    </button>
                    <button class="btn btn-info" onclick="window.location.href='{{ url_for('documents_manager') }}'">
                        <i class="fas fa-upload"></i> Upload Scope Document
                    </button>
                    <button class="btn btn-warning" onclick="generateReport()">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Vulnerability Distribution -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Vulnerability Types</h5>
            </div>
            <div class="card-body">
                <canvas id="vulnChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Targets -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-crosshairs"></i> Recent Targets</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshTargets()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <a href="{{ url_for('targets') }}" class="btn btn-sm btn-primary">View All</a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_targets %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Target</th>
                                <th>Status</th>
                                <th>Last Scan</th>
                                <th>Vulnerabilities</th>
                                <th>Risk Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for target in recent_targets %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-globe me-2 text-primary"></i>
                                        <div>
                                            <strong>{{ target[1] }}</strong>
                                            {% if target[7] %}
                                            <br><small class="text-muted">{{ target[7] }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if target[2] == 'completed' %}
                                    <span class="badge badge-success">Scanned</span>
                                    {% elif target[2] == 'scanning' %}
                                    <span class="badge badge-warning">Scanning</span>
                                    {% else %}
                                    <span class="badge badge-info">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if target[4] %}
                                    <span class="text-muted">{{ target[4] }}</span>
                                    {% else %}
                                    <span class="text-muted">Never</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-danger">{{ target[5] or 0 }}</span>
                                </td>
                                <td>
                                    {% set risk_score = target[16] or 0 %}
                                    {% if risk_score >= 80 %}
                                    <span class="badge badge-danger">{{ risk_score }}</span>
                                    {% elif risk_score >= 60 %}
                                    <span class="badge badge-warning">{{ risk_score }}</span>
                                    {% elif risk_score >= 40 %}
                                    <span class="badge badge-info">{{ risk_score }}</span>
                                    {% else %}
                                    <span class="badge badge-success">{{ risk_score }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-primary" onclick="quickScan({{ target[0] }})">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <button class="btn btn-info" onclick="viewTarget({{ target[0] }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-success" onclick="showIntelligence({{ target[0] }})">
                                            <i class="fas fa-brain"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-crosshairs text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">No targets found</h5>
                    <p class="text-muted">Add your first target to get started with bug bounty hunting</p>
                    <a href="{{ url_for('add_target') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Target
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Target Modal -->
<div class="modal fade" id="addTargetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Quick Add Target</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickTargetForm">
                    <div class="mb-3">
                        <label for="quickDomain" class="form-label">Domain</label>
                        <input type="text" class="form-control" id="quickDomain" placeholder="example.com" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quickProgram" class="form-label">Program Name</label>
                                <input type="text" class="form-control" id="quickProgram" placeholder="Bug Bounty Program">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quickReward" class="form-label">Reward Range</label>
                                <input type="text" class="form-control" id="quickReward" placeholder="$100 - $5000">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="quickScanNow">
                            <label class="form-check-label" for="quickScanNow">
                                Start scanning immediately
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickTarget()">
                    <i class="fas fa-plus"></i> Add Target
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Initialize vulnerability chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('vulnChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['XSS', 'SQL Injection', 'CSRF', 'LFI', 'Other'],
            datasets: [{
                data: [{{ vuln_stats.xss or 0 }}, {{ vuln_stats.sqli or 0 }}, {{ vuln_stats.csrf or 0 }}, {{ vuln_stats.lfi or 0 }}, {{ vuln_stats.other or 0 }}],
                backgroundColor: [
                    '#ff6b6b',
                    '#4ecdc4',
                    '#45b7d1',
                    '#f7b801',
                    '#6c5ce7'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        color: '#e8e8f0'
                    }
                }
            }
        }
    });
});

// Dashboard functions
function showAddTargetModal() {
    new bootstrap.Modal(document.getElementById('addTargetModal')).show();
}

function submitQuickTarget() {
    const domain = document.getElementById('quickDomain').value;
    const program = document.getElementById('quickProgram').value;
    const reward = document.getElementById('quickReward').value;
    const scanNow = document.getElementById('quickScanNow').checked;

    if (!domain) {
        showNotification('Please enter a domain', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('domain', domain);
    formData.append('program_name', program);
    formData.append('reward_range', reward);

    fetch('/add_target', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Target added successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addTargetModal')).hide();
            
            if (scanNow) {
                quickScan(data.target_id);
            }
            
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error || 'Failed to add target', 'danger');
        }
    })
    .catch(error => {
        showNotification('Error adding target', 'danger');
        console.error(error);
    });
}

function startQuickScan() {
    showNotification('Starting quick scan on all targets...', 'info');
    
    fetch('/api/quick_scan_all', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Started scanning ${data.count} targets`, 'success');
        } else {
            showNotification('Failed to start quick scan', 'danger');
        }
    })
    .catch(error => {
        showNotification('Error starting scan', 'danger');
    });
}

function quickScan(targetId) {
    showNotification('Starting quick scan...', 'info');
    
    fetch(`/scan/${targetId}`)
    .then(response => {
        if (response.ok) {
            showNotification('Scan started successfully!', 'success');
            setTimeout(checkScanStatus, 2000, targetId);
        } else {
            showNotification('Failed to start scan', 'danger');
        }
    })
    .catch(error => {
        showNotification('Error starting scan', 'danger');
    });
}

function viewTarget(targetId) {
    window.location.href = `/target/${targetId}`;
}

function showIntelligence(targetId) {
    window.location.href = `/intelligence/${targetId}`;
}

function runFullScan() {
    if (confirm('This will run a comprehensive scan on all targets. Continue?')) {
        showNotification('Starting full scan...', 'info');
        
        fetch('/api/run_full_scan', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Full scan started!', 'success');
            } else {
                showNotification('Failed to start full scan', 'danger');
            }
        });
    }
}

function generateReport() {
    showNotification('Generating report...', 'info');
    
    fetch('/api/generate_dashboard_report', {
        method: 'POST'
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'bb_dashboard_report.pdf';
        a.click();
        showNotification('Report generated successfully!', 'success');
    })
    .catch(error => {
        showNotification('Failed to generate report', 'danger');
    });
}

function refreshTargets() {
    const refreshBtn = document.querySelector('[onclick="refreshTargets()"]');
    const icon = refreshBtn.querySelector('i');
    
    icon.classList.add('fa-spin');
    
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function checkScanStatus(targetId) {
    fetch(`/api/scan_status/${targetId}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'completed') {
            showNotification('Scan completed!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else if (data.status === 'running') {
            showNotification('Scan in progress...', 'info');
            setTimeout(checkScanStatus, 5000, targetId);
        } else if (data.status === 'failed') {
            showNotification('Scan failed', 'danger');
        }
    });
}

// Auto-refresh dashboard every 30 seconds
setInterval(() => {
    // Refresh activity and stats without full page reload
    fetch('/api/dashboard_data')
    .then(response => response.json())
    .then(data => {
        // Update stats if they've changed
        if (data.stats) {
            document.querySelector('.stats-card:nth-child(1) .stats-number').textContent = data.stats.targets;
            document.querySelector('.stats-card:nth-child(2) .stats-number').textContent = data.stats.vulnerabilities;
            document.querySelector('.stats-card:nth-child(3) .stats-number').textContent = '$' + data.stats.payouts;
            document.querySelector('.stats-card:nth-child(4) .stats-number').textContent = data.stats.active_scans;
        }
    })
    .catch(error => {
        console.log('Auto-refresh failed:', error);
    });
}, 30000);
</script>
{% endblock %}
